<% if (typeof success !== 'undefined' && success) { %>
    <div class="alert alert-success"><%= success %></div>
<% } %>
<% if (typeof error !== 'undefined' && error) { %>
    <div class="alert alert-error"><%= error %></div>
<% } %>

<div style="display: flex; justify-content: space-between; align-items: center; margin: 20px 0;">
    <h1>Livros</h1>
    <a href="/books/new" class="btn btn-primary">+ Adicionar Livro</a>
</div>

<div class="stats">
    <div class="stat-card">
        <h3><%= stats.pending %></h3>
        <p>Pendentes</p>
    </div>
    <div class="stat-card">
        <h3><%= stats.sent %></h3>
        <p>Enviados</p>
    </div>
    <div class="stat-card">
        <h3><%= stats.error %></h3>
        <p>Com Erro</p>
    </div>
</div>

<div class="card">
    <% if (books.length > 0) { %>
        <table>
            <thead>
                <tr>
                    <th>T√≠tulo</th>
                    <th>Autor</th>
                    <th>Status</th>
                    <th>Data</th>
                    <th>A√ß√µes</th>
                </tr>
            </thead>
            <tbody>
                <% books.forEach(book => { %>
                    <tr>
                        <td><strong><%= book.title %></strong></td>
                        <td><%= book.author %></td>
                        <td>
                            <form method="POST" action="/books/status/<%= book.id %>" style="display: inline;">
                                <select name="status" onchange="this.form.submit()" style="padding: 5px; border-radius: 4px; border: 1px solid #ddd;">
                                    <option value="pending" <%= book.status === 'pending' ? 'selected' : '' %>>‚è≥ Pendente</option>
                                    <option value="sent" <%= book.status === 'sent' ? 'selected' : '' %>>‚úÖ Enviado</option>
                                    <option value="error" <%= book.status === 'error' ? 'selected' : '' %>>‚ùå Erro</option>
                                </select>
                            </form>
                        </td>
                        <td><%= new Date(book.created_at).toLocaleDateString('pt-BR') %></td>
                        <td style="white-space: nowrap;">
                            <button 
                                class="btn btn-primary send-now-btn" 
                                data-book-id="<%= book.id %>" 
                                data-book-title="<%= book.title %>"
                                style="padding: 5px 10px; font-size: 12px; margin-right: 5px;">
                                üì§ Enviar Agora
                            </button>
                            <a href="/books/edit/<%= book.id %>" class="btn btn-secondary" style="padding: 5px 10px; font-size: 12px; margin-right: 5px;">
                                ‚úèÔ∏è Editar
                            </a>
                            <form method="POST" action="/books/delete/<%= book.id %>" style="display: inline;" onsubmit="return confirm('Tem certeza que deseja deletar este livro?')">
                                <button type="submit" class="btn btn-danger" style="padding: 5px 10px; font-size: 12px;">
                                    üóëÔ∏è Deletar
                                </button>
                            </form>
                        </td>
                    </tr>
                <% }); %>
            </tbody>
        </table>
    <% } else { %>
        <p>Nenhum livro cadastrado ainda.</p>
    <% } %>
</div>

<div id="send-result" style="margin-top: 20px;"></div>

<script>
    // Adicionar evento a todos os bot√µes "Enviar Agora"
    document.querySelectorAll('.send-now-btn').forEach(button => {
        button.addEventListener('click', async function() {
            const bookId = this.getAttribute('data-book-id');
            const bookTitle = this.getAttribute('data-book-title');
            
            if (!confirm(`Deseja enviar o livro "${bookTitle}" AGORA para o grupo do WhatsApp?`)) {
                return;
            }
            
            const resultDiv = document.getElementById('send-result');
            resultDiv.innerHTML = '<div class="alert alert-success">üì§ Enviando livro "' + bookTitle + '"...</div>';
            
            try {
                const response = await fetch(`/books/send-now/${bookId}`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    }
                });
                
                const data = await response.json();
                
                if (data.success) {
                    resultDiv.innerHTML = '<div class="alert alert-success">‚úÖ ' + data.message + '</div>';
                    setTimeout(() => {
                        window.location.reload();
                    }, 2000);
                } else {
                    resultDiv.innerHTML = '<div class="alert alert-error">‚ùå ' + data.message + '</div>';
                }
            } catch (error) {
                resultDiv.innerHTML = '<div class="alert alert-error">‚ùå Erro: ' + error.message + '</div>';
            }
        });
    });
</script>

<style>
    select {
        cursor: pointer;
        background: white;
    }
    
    select:hover {
        border-color: #25D366;
    }
    
    .btn {
        cursor: pointer;
    }
</style>
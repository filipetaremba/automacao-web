<h1>Configurações</h1>

<% if (typeof success !== 'undefined' && success) { %>
    <div class="alert alert-success"><%= success %></div>
<% } %>
<% if (typeof error !== 'undefined' && error) { %>
    <div class="alert alert-error"><%= error %></div>
<% } %>

<div class="card">
    <h2>Configurações Gerais</h2>
    <form method="POST" action="/settings">
        <div class="form-group">
            <label>ID do Grupo WhatsApp</label>
            <input type="text" name="group_id" value="<%= settings.group_id || '' %>" placeholder="123456789-1234567890@g.us">
            <small>Execute o teste do WhatsApp para obter o ID do grupo</small>
        </div>
        
        <div class="form-group">
            <label>Horário de Envio (Cron)</label>
            <select name="cron_schedule">
                <% for (let key in presets) { %>
                    <option value="<%= presets[key] %>" <%= settings.cron_schedule === presets[key] ? 'selected' : '' %>>
                        <%= key %>: <%= presets[key] %>
                    </option>
                <% } %>
            </select>
            <small>Atual: <%=description %></small>
</div>    <button type="submit" class="btn btn-primary">Salvar Configurações</button>
</form>
</div>
<div class="card">
    <h2>Controle do Agendador</h2>
    <button onclick="toggleScheduler()" class="btn btn-primary">
        Iniciar/Parar Agendador
    </button>
    <button onclick="sendNow()" class="btn btn-secondary">
        Enviar Agora (Teste)
    </button>
    <div id="result" style="margin-top: 15px;"></div>
</div>
<script>
    async function toggleScheduler() {
        const result = document.getElementById('result');
        try {
            const res = await fetch('/settings/toggle-scheduler', { method: 'POST' });
            const data = await res.json();
            result.innerHTML = `<div class="alert ${data.success ? 'alert-success' : 'alert-error'}">${data.message}</div>`;
            setTimeout(() => location.reload(), 2000);
        } catch (error) {
            result.innerHTML = `<div class="alert alert-error">Erro: ${error.message}</div>`;
        }
    }
    
    async function sendNow() {
        if (!confirm('Isso vai enviar um livro AGORA. Confirmar?')) return;
        
        const result = document.getElementById('result');
        result.innerHTML = '<div class="alert alert-success">Enviando...</div>';
        
        try {
            const res = await fetch('/settings/send-now', { method: 'POST' });
            const data = await res.json();
            result.innerHTML = `<div class="alert ${data.success ? 'alert-success' : 'alert-error'}">${data.message}</div>`;
        } catch (error) {
            result.innerHTML = `<div class="alert alert-error">Erro: ${error.message}</div>`;
        }
    }
</script>